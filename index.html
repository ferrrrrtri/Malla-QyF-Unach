<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Malla Interactiva QyF UNACH</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&display=swap');

    /* Base/Default (Light) Theme */
    :root {
      --bg: #e0f7fa; /* Light Blue */
      --text: #333;
      --card: #fff;
      --accent: #1565C0; /* Strong Blue */
      --accent2: #42A5F5; /* Lighter Blue */
      --green: #10B981; /* Teal Green */
      --yellow: #FACC15; /* Amber Yellow */
      --lila: #9C27B0; /* Deep Purple */
      --red: #EF5350; /* Red */
      --shadow: rgba(0,0,0,0.1);
      --ramo-bg: #eceff1; /* Light Gray Blue */
      --ramo-aprobado-bg: #e1f5fe; /* Very Light Blue */
      --ramo-desbloqueado-bg: #fff8e1; /* Very Light Yellow */
      --creditos-bg: rgba(255, 255, 255, 0.8); /* Slightly transparent white for credits */
      --success-modal-bg: #e8f5e9; /* Light green for success modal */
      --success-modal-text: #1b5e20; /* Dark green for success modal text */
    }

    /* Dark Theme */
    body.dark {
      --bg: #1a1a1a;
      --text: #eee;
      --card: #2c2c2c;
      --accent: #4a90e2;
      --accent2: #72aeff;
      --green: #4CAF50;
      --yellow: #FFEB3B;
      --lila: #AB47BC;
      --red: #FF5252;
      --shadow: rgba(0,0,0,0.4);
      --ramo-bg: #3c3c3c;
      --ramo-aprobado-bg: #30475e;
      --ramo-desbloqueado-bg: #5f4b00;
      --creditos-bg: rgba(44, 44, 44, 0.8); /* Slightly transparent dark for credits */
      --success-modal-bg: #388e3c; /* Darker green for success modal */
      --success-modal-text: #e8f5e9; /* Light text for success modal */
    }

    /* Pastel Theme */
    body.pastel {
      --bg: #f8e1fa; /* Light pink/purple */
      --text: #5d3f6a; /* Darker purple */
      --card: #fefefe;
      --accent: #d8a7e0; /* Medium purple */
      --accent2: #e9c3f0; /* Lighter purple */
      --green: #a7d8b0; /* Pastel green */
      --yellow: #f0e68c; /* Khaki */
      --lila: #c3a7e0;
      --red: #f0a7a7;
      --shadow: rgba(0,0,0,0.1);
      --ramo-bg: #f3e9f5;
      --ramo-aprobado-bg: #e0f0e0;
      --ramo-desbloqueado-bg: #f5f5e0;
      --creditos-bg: rgba(254, 254, 254, 0.8);
      --success-modal-bg: #a7d8b0;
      --success-modal-text: #5d3f6a;
    }

    /* Celeste Theme */
    body.celeste {
      --bg: #e0f7fa; /* Light blue */
      --text: #004d40; /* Dark teal */
      --card: #ffffff;
      --accent: #00838f; /* Cyan dark */
      --accent2: #00acc1; /* Cyan light */
      --green: #4db6ac; /* Greenish blue */
      --yellow: #ffb74d; /* Orange */
      --lila: #7986cb; /* Indigo */
      --red: #ef5350;
      --shadow: rgba(0,0,0,0.1);
      --ramo-bg: #e0f2f7;
      --ramo-aprobado-bg: #b2ebf2;
      --ramo-desbloqueado-bg: #ffe0b2;
      --creditos-bg: rgba(255, 255, 255, 0.8);
      --success-modal-bg: #4db6ac;
      --success-modal-text: #004d40;
    }

    /* Rosado Theme */
    body.rosado {
      --bg: #ffebee; /* Very light pink */
      --text: #880e4f; /* Darker pink */
      --card: #ffffff;
      --accent: #c2185b; /* Medium pink */
      --accent2: #e91e63; /* Brighter pink */
      --green: #a5d6a7; /* Light green */
      --yellow: #ffcc80; /* Light orange */
      --lila: #ce93d8; /* Light purple */
      --red: #ef9a9a;
      --shadow: rgba(0,0,0,0.1);
      --ramo-bg: #fce4ec;
      --ramo-aprobado-bg: #f8bbd0;
      --ramo-desbloqueado-bg: #fff9c4;
      --creditos-bg: rgba(255, 255, 255, 0.8);
      --success-modal-bg: #e91e63;
      --success-modal-text: #ffffff;
    }

    /* Verde Theme */
    body.verde {
      --bg: #e8f5e9; /* Very light green */
      --text: #1b5e20; /* Dark green */
      --card: #ffffff;
      --accent: #388e3c; /* Medium green */
      --accent2: #4caf50; /* Brighter green */
      --green: #81c784; /* Light green */
      --yellow: #fff176; /* Light yellow */
      --lila: #9ccc65; /* Lime green */
      --red: #ef5350;
      --shadow: rgba(0,0,0,0.1);
      --ramo-bg: #e0f2f1;
      --ramo-aprobado-bg: #c8e6c9;
      --ramo-desbloqueado-bg: #fffde7;
      --creditos-bg: rgba(255, 255, 255, 0.8);
      --success-modal-bg: #4caf50;
      --success-modal-text: #ffffff;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: 'Inter', sans-serif;
      background: var(--bg); color: var(--text);
      transition: background .3s, color .3s;
      overflow-x: hidden; /* Prevent horizontal scrolling on small screens */
    }
    /* HEADER PRINCIPAL */
    #main-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 24px;
      background: linear-gradient(90deg,var(--accent2),var(--accent));
      color: #fff; font-family: 'Playfair Display', serif;
      position: sticky; top: 0; z-index: 1000;
      box-shadow: 0 2px 4px var(--shadow);
      flex-wrap: wrap; /* Allow items to wrap on smaller screens */
      gap: 10px; /* Space between header items */
    }
    #header-left { display: flex; align-items: center; }
    #header-left img { height: 40px; margin-right: 12px; }
    #malla-link a {
      color: #fff; font-weight: 600; text-decoration: none;
      padding: 4px 8px; background: rgba(255,255,255,0.2); border-radius: 4px;
      transition: background .2s;
    }
    #malla-link a:hover { background: rgba(255,255,255,0.4); }
    #header-title {
        font-size: 1.6em;
        font-weight: 700;
        text-align: center;
        position: relative; /* Para posicionar el texto adicional */
        flex-grow: 1; /* Allow title to take available space */
    }
    #unach-qf-link {
        color: inherit; /* Hereda el color del padre (blanco en header) */
        text-decoration: none; /* Sin subrayado por defecto */
        transition: text-decoration 0.2s;
    }
    #unach-qf-link:hover {
        text-decoration: underline; /* Subrayar al pasar el ratón */
    }
    #university-name {
        display: block; /* Para que esté en una nueva línea */
        font-size: 0.8em; /* Tamaño de fuente más grande para el nombre de la universidad */
        font-weight: 600;
        color: inherit; /* Hereda el color del padre */
        margin-top: 2px; /* Pequeño margen superior */
    }

    #header-right {
      display: flex; align-items: center; gap: 12px;
      font-size: .9em;
      flex-wrap: wrap; /* Allow items to wrap */
      justify-content: flex-end; /* Align to the right */
    }
    #clock {
      padding: 4px 8px; background: rgba(255,255,255,0.2);
      border-radius: 4px; font-family: monospace; min-width: 120px; /* Increased width for date */
      text-align: center;
    }
    /* Theme Selector */
    #theme-selector {
        padding: 6px 8px;
        border: none;
        border-radius: 4px;
        font-size: .9em;
        background: var(--card); /* Color de fondo para inputs/selects */
        color: var(--text); /* Color de texto para inputs/selects */
    }

    /* BARRA SECUNDARIA */
    #topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 20px; background: var(--accent);
      color: #fff; position: sticky; top: 72px; z-index: 900;
      box-shadow: 0 2px 4px var(--shadow);
      font-size: .9em;
      flex-wrap: wrap; /* Allow items to wrap on smaller screens */
      gap: 10px; /* Space between topbar items */
    }

    /* Combined Info Section */
    #combined-info {
        background: rgba(255,255,255,0.1);
        padding: 5px 10px;
        border-radius: 8px;
        transition: background 0.2s ease;
        white-space: nowrap; /* Keep summary text on one line */
    }
    #combined-info summary {
        cursor: pointer;
        font-weight: 600;
        outline: none; /* Quitar el contorno al hacer clic */
        display: flex; /* Use flex to align text and custom marker */
        align-items: center;
        justify-content: space-between; /* Push marker to the right */
    }
    #combined-info summary::-webkit-details-marker {
        display: none; /* Ocultar el marcador predeterminado */
    }
    #combined-info summary:after { /* Custom marker for details summary */
        content: '\25B6'; /* Right-pointing triangle */
        font-size: 0.8em;
        margin-left: 8px;
        transition: transform 0.2s;
    }
    #combined-info[open] summary:after {
        content: '\25BC'; /* Down-pointing triangle when open */
    }
    #combined-info > div { /* Target the div directly inside details for content */
        margin-top: 5px; /* Espacio para el contenido desplegado */
        display: flex;
        flex-direction: column; /* Stack details content vertically */
        gap: 5px; /* Smaller gap for stacked items */
        font-size: 0.85em; /* Slightly smaller font for details content */
    }
    #combined-info ul {
      list-style: none; margin: 0; padding-left: 0; font-size: .9em;
    }
    #combined-info ul li {
        margin-bottom: 4px;
    }
    #combined-info ul li:last-child {
        margin-bottom: 0;
    }


    #topbar-controls {
      display: flex; align-items: center; gap: 12px;
      flex-wrap: wrap; /* Allow controls to wrap */
      justify-content: flex-end; /* Align to the right */
      flex-grow: 1; /* Allow controls to take available space */
    }
    #topbar-controls input[type="text"],
    #topbar-controls select {
      padding: 6px 8px; border: none; border-radius: 4px;
      font-size: .9em;
      background: var(--card); /* Color de fondo para inputs/selects */
      color: var(--text); /* Color de texto para inputs/selects */
    }
    #topbar-controls button {
      background: var(--accent2); border: none; color: #fff;
      padding: 6px 10px; border-radius: 4px; cursor: pointer;
      transition: background .2s; font-size: .9em;
    }
    #topbar-controls button:hover { background: #2e7dff; }
    #contador { font-weight: 600; margin-left: 8px; }

    /* Nuevo estilo para la sección de créditos en el topbar (solo total) */
    #creditos-info {
        margin-left: 15px;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--creditos-bg); /* Fondo similar al card, pero distinto */
        padding: 8px 12px;
        border-radius: 8px; /* Bordes redondeados */
        box-shadow: 0 1px 3px var(--shadow); /* Sombra ligera */
        color: var(--text); /* Asegura que el texto sea visible */
    }
    #creditos-info .dot { /* Hide dots from topbar credits */
        display: none;
    }
    #creditos-info span {
        font-weight: 600;
    }
    #creditos-total {
        font-size: 1.1em;
    }

    /* Estilo para el nuevo botón de información del tr._nico */
    .btn-info {
        background: var(--accent2);
        border: none;
        color: #fff;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: background .2s;
        font-size: .9em;
        font-weight: 700;
        width: 30px; /* Para que sea un botón cuadrado */
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .btn-info:hover {
        background: #2e7dff;
    }


    /* LAYOUT PRINCIPAL */
    #content-wrapper {
      display: flex; gap: 20px; padding: 20px;
      align-items: flex-start; /* Alinea los elementos al inicio */
      flex-wrap: wrap; /* Allow content to wrap on smaller screens */
    }
    /* LEYENDA ÁREAS */
    #legend {
      background: var(--card); padding: 12px; border-radius: 8px;
      box-shadow: 0 2px 6px var(--shadow); min-width: 180px;
      color: var(--text); /* Asegura que el texto sea visible en modo oscuro */
      margin-bottom: 20px; /* Espacio entre la leyenda y los nuevos widgets */
    }
    #legend table { width: 100%; border-collapse: collapse; font-size: .9em; }
    #legend th { padding-bottom: 8px; text-align: left; }
    #legend td { padding: 4px 0; display: flex; align-items: center; justify-content: space-between; } /* Added flex for alignment */
    #legend td span:last-child { margin-left: auto; font-weight: 600; } /* Align credit count to right */

    .dot {
      display: inline-block; width: 10px; height: 10px;
      border-radius: 50%; margin-right: 6px; vertical-align: middle;
    }
    .area-espiritual { background: green; }
    .area-general    { background: #00bcd4; }
    .area-profesional{ background: var(--yellow); }
    .area-especialidad { background: var(--lila); }
    .area-practica   { background: red; }

    /* Nuevo estilo para la barra lateral de widgets */
    #left-sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px; /* Espacio entre la leyenda y el panel de widgets */
      min-width: 200px; /* Ancho mínimo para la barra lateral */
      max-width: 250px; /* Ancho máximo */
      flex-shrink: 0; /* Evita que la barra lateral se encoja */
      width: 100%; /* Default to full width on small screens */
    }

    #widgets-panel {
      background: var(--card);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 15px; /* Espacio entre los widgets */
    }

    #widgets-panel h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--accent);
      text-align: center;
      font-size: 1.2em;
    }

    .widget-card {
      padding: 10px;
      border-radius: 6px;
      background: var(--ramo-bg); /* Un color de fondo suave para los widgets */
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      text-align: center;
    }

    .widget-card h4 {
      margin-top: 0;
      margin-bottom: 8px;
      color: var(--accent2);
      font-size: 1em;
    }

    .widget-card a {
      display: inline-block;
      background: var(--accent);
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.2s ease;
    }

    .widget-card a:hover {
      background: #0d47a1;
    }

    /* Calendar Widget Specific Styles */
    #calendar-widget {
        text-align: left;
    }
    #calendar-widget h4 {
        text-align: center;
    }
    #calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    #calendar-header button {
        background: var(--accent);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
    }
    #calendar-header button:hover {
        background: #0d47a1;
    }
    #calendar-header h5 {
        margin: 0;
        font-size: 1.1em;
        color: var(--accent);
    }
    #calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        font-size: 0.85em;
    }
    .day-name {
        background: var(--accent2);
        color: white;
        padding: 5px 0;
        text-align: center;
        font-weight: 600;
    }
    .calendar-day {
        background: var(--ramo-bg);
        padding: 5px;
        text-align: center;
        min-height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 3px;
    }
    .calendar-day.empty {
        background: #eee; /* Lighter background for empty days */
        color: #ccc;
    }
    body.dark .calendar-day.empty {
        background: #444;
        color: #777;
    }
    .calendar-day.current-day {
        background: var(--green);
        color: white;
        font-weight: 700;
    }


    /* MALLA Y ZOOM */
    #malla-container {
      overflow: auto; transform-origin: top center;
      flex-grow: 1; /* Permite que la malla ocupe el espacio restante */
    }
    #malla {
      display: flex; flex-direction: column; gap: 24px;
      width: max-content; margin: auto;
    }
    .year {
      display: grid;
      grid-template-columns: repeat(2, minmax(240px,1fr));
      gap: 20px;
      background: var(--card);
      border-radius: 8px;
      box-shadow: 0 2px 6px var(--shadow);
      position: relative;
      transition: border 0.3s, box-shadow 0.3s, background 0.3s;
    }
    .year[data-year-complete] {
      border: 2px solid gold;
      box-shadow: 0 0 8px rgba(255,215,0,0.8);
    }
    .year-label {
      grid-column: 1 / -1;
      background: linear-gradient(90deg,var(--accent2),var(--accent)); /* Gradient background */
      color: #fff;
      text-align: center;
      padding: 10px;
      font-weight: 600;
      font-size: 1.1em;
      display: flex; /* Usar flexbox para alinear el título y el botón de sello */
      justify-content: space-between; /* Espacio entre el título y el botón */
      align-items: center; /* Centrar verticalmente */
      padding-left: 20px; /* Ajuste de padding para el texto */
      padding-right: 20px; /* Ajuste de padding para el botón */
    }
    .horas-sellos-btn {
        background: rgba(255,255,255,0.2);
        color: #fff;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8em;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease;
        white-space: nowrap; /* Evita que el texto se rompa */
    }
    .horas-sellos-btn:hover {
        background: rgba(255,255,255,0.4);
    }
    .semestre {
      padding: 12px;
      display: flex;
      flex-direction: column;
    }
    .semestre::before {
      content: attr(data-sem)"° Semestre";
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 10px;
    }
    .progress {
      width: 100%; height: 8px;
      background: #ddd; /* Fondo de la barra de progreso */
      border-radius: 4px;
      overflow: hidden; margin-bottom: 10px;
    }
    body.dark .progress {
        background: #555; /* Fondo de la barra de progreso en modo oscuro */
    }
    .progress-fill {
      width: 0; height: 100%;
      background: var(--green);
      transition: width .3s;
    }
    .ramo {
      background: var(--ramo-bg);
      margin: 6px 0;
      padding: 8px 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: transform .2s, box-shadow .2s, background .2s, color .2s;
      border-left: 4px solid transparent;
      font-size: .95em;
      display: flex; align-items: center;
      color: var(--text); /* Asegura que el texto sea visible */
    }
    .ramo .dot { margin-right: 8px; }
    .ramo:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    /* ANIMACIONES DE RAMOS */
    .aprobado {
      background: var(--ramo-aprobado-bg) !important;
      border-left-color: var(--green) !important;
      animation: sparkle-green 0.6s ease-out forwards; /* Animación al aprobar */
    }
    @keyframes sparkle-green {
        0% { transform: scale(1); box-shadow: 0 0 0 var(--green); opacity: 1; }
        50% { transform: scale(1.03); box-shadow: 0 0 15px var(--green), 0 0 30px var(--green); opacity: 0.8; }
        100% { transform: scale(1); box-shadow: 0 0 0 var(--green); opacity: 1; }
    }

    .desbloqueado {
      background: var(--ramo-desbloqueado-bg) !important;
      border-left-color: var(--yellow) !important;
      animation: pulse-yellow 1.5s infinite alternate ease-in-out; /* Animación parpadeante */
    }
    @keyframes pulse-yellow {
        0% { box-shadow: 0 0 0 rgba(250, 204, 21, 0.4); }
        100% { box-shadow: 0 0 15px rgba(250, 204, 21, 0.8); }
    }

    .error {
      animation: shake .3s;
      background: var(--red) !important;
      color: #fff !important;
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }
    .highlight {
      border: 2px solid gold !important;
      animation: pulse 1s infinite alternate;
    }
    @keyframes pulse {
      from { box-shadow: 0 0 0 rgba(255,215,0,0.5); }
      to   { box-shadow: 0 0 10px rgba(255,215,0,1); }
    }
    .empty { visibility: hidden; }
    /* INFO Y CALCULADORAS */
    .calc-box {
      background: var(--card);
      padding: 8px 12px;
      margin: 8px 0;
      border-radius: 4px;
      box-shadow: 0 1px 3px var(--shadow);
    }
    .calc-box a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }

    /* Estilos para los Modales */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
    }

    .modal-backdrop.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: var(--card);
      color: var(--text);
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px var(--shadow);
      width: 90%;
      max-width: 500px;
      transform: translateY(-20px);
      transition: transform 0.3s ease;
      position: relative;
    }

    .modal-backdrop.show .modal-content {
      transform: translateY(0);
    }

    .modal-close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: var(--text);
    }

    .modal-title {
      font-size: 1.5em;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--accent);
    }

    .modal-info p {
      margin-bottom: 8px;
      font-size: 0.95em;
    }

    .modal-info p strong {
      color: var(--accent2);
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-buttons button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s ease;
    }

    .modal-buttons .btn-aprobado {
      background-color: var(--green);
      color: white;
    }

    .modal-buttons .btn-aprobado:hover {
      background-color: #0b9e6f;
    }

    .modal-buttons .btn-desmarcar {
      background-color: var(--red);
      color: white;
    }

    .modal-buttons .btn-desmarcar:hover {
      background-color: #d84315;
    }

    .modal-buttons .btn-close {
        background-color: #ccc;
        color: var(--text);
    }

    .modal-buttons .btn-close:hover {
        background-color: #bbb;
    }

    /* Estilos para el modal de confirmación personalizado */
    .custom-confirm-modal .modal-content {
        max-width: 400px;
        text-align: center;
    }
    .custom-confirm-modal .modal-title {
        color: var(--red);
    }
    .custom-confirm-modal .modal-buttons {
        justify-content: center;
    }

    /* Estilos para el modal de mensaje personalizado (tr._nico) */
    .custom-alert-modal .modal-content {
        max-width: 400px;
        text-align: center;
    }
    .custom-alert-modal .modal-title {
        color: var(--accent); /* Color principal para el título del mensaje */
    }
    .custom-alert-modal .modal-buttons {
        justify-content: center;
    }

    /* Nuevo Modal de Felicidades por Semestre */
    #semester-complete-modal .modal-content {
        background-color: var(--success-modal-bg);
        color: var(--success-modal-text);
        border: 3px solid var(--green);
        animation: bounceIn 0.6s ease-out;
        text-align: center;
        max-width: 550px;
    }
    #semester-complete-modal .modal-title {
        color: var(--success-modal-text);
        font-size: 2em;
        margin-bottom: 10px;
    }
    #semester-complete-modal p {
        font-size: 1.2em;
        margin-bottom: 20px;
    }
    #semester-complete-modal .modal-buttons {
        justify-content: center;
    }
    #semester-complete-modal .modal-buttons .btn-close {
        background-color: var(--green);
        color: white;
    }
    #semester-complete-modal .modal-buttons .btn-close:hover {
        background-color: #0b9e6f;
    }

    @keyframes bounceIn {
        0% { transform: scale(0.3); opacity: 0; }
        50% { transform: scale(1.05); opacity: 1; }
        70% { transform: scale(0.9); }
        100% { transform: scale(1); }
    }

    /* --- Responsive Design --- */
    @media (max-width: 1024px) {
        #main-header, #topbar {
            padding: 10px;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        #header-right, #topbar-controls {
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        #header-title {
            font-size: 1.3em;
        }
        #university-name {
            font-size: 0.7em;
        }
        #clock {
            min-width: unset;
            width: auto;
        }
        #creditos-info {
            margin-left: 0;
            width: 100%;
            justify-content: center;
        }
        #content-wrapper {
            flex-direction: column;
            padding: 15px;
            gap: 15px;
        }
        #left-sidebar {
            max-width: 100%;
            min-width: unset;
        }
        #malla-container {
            width: 100%;
            overflow-x: auto; /* Allow horizontal scroll for the malla if it's too wide */
        }
        #malla {
            width: fit-content; /* Allow malla to take its natural width */
            margin: 0 auto;
        }
        .year {
            grid-template-columns: 1fr; /* Stack semestres vertically */
            gap: 15px;
        }
        .year-label {
            padding: 10px 15px;
            flex-direction: column;
            gap: 5px;
        }
        .horas-sellos-btn {
            font-size: 0.75em;
            padding: 4px 8px;
        }
        .ramo {
            font-size: 0.9em;
            padding: 6px 8px;
        }
        #combined-info summary {
            width: 100%; /* Make summary take full width */
        }
        #combined-info > div {
            width: 100%;
        }
    }

    @media (max-width: 600px) {
        #main-header {
            padding: 8px 10px;
        }
        #header-left img {
            height: 30px;
        }
        #header-title {
            font-size: 1.1em;
        }
        #university-name {
            font-size: 0.6em;
        }
        #topbar {
            padding: 8px 10px;
            font-size: 0.8em;
        }
        #topbar-controls button,
        #topbar-controls input,
        #topbar-controls select {
            font-size: 0.8em;
            padding: 5px 8px;
        }
        #creditos-info {
            font-size: 0.8em;
            padding: 6px 10px;
        }
        #legend {
            font-size: 0.8em;
            padding: 10px;
        }
        .widget-card h4 {
            font-size: 0.9em;
        }
        .widget-card a {
            padding: 6px 10px;
            font-size: 0.85em;
        }
        /* Further adjust malla layout if needed for very small screens */
        .ramo {
            font-size: 0.85em;
        }
    }

  </style>
</head>
<body>
  <!-- HEADER PRINCIPAL -->
  <header id="main-header">
    <div id="header-left">
      <img src="logo.png" alt="Logo UNACH">
      <div id="malla-link">
        <a href="https://www.unach.cl/wp-content/uploads/2022/11/Qui%CC%81micayFarmacia-2023.pdf" target="_blank">
          Malla QyF
        </a>
      </div>
    </div>
    <div id="header-title">
      <!-- Título principal ahora es un enlace -->
      <a href="https://www.unach.cl/quimica-y-farmacia/" target="_blank" id="unach-qf-link">
        Química y Farmacia
      </a><br>
      <!-- Nombre de la universidad con tamaño de fuente más grande -->
      <span id="university-name">Universidad Adventista de Chile</span>
    </div>
    <div id="header-right">
      Zoom <input id="zoom" type="range" min="50" max="150" value="100"/>%
      <label for="theme-selector">Tema:</label>
      <select id="theme-selector">
        <option value="light">Claro</option>
        <option value="dark">Oscero</option>
        <option value="pastel">Pastel</option>
        <option value="celeste">Celeste</option>
        <option value="rosado">Rosado</option>
        <option value="verde">Verde</option>
      </select>
      <div id="clock"></div>
    </div>
  </header>

  <!-- BARRA SECUNDARIA -->
  <div id="topbar">
    <div id="topbar-controls">
      <!-- Botón de información del tr._nico -->
      <button id="tr-nico-info-btn" class="btn-info">?</button>
      <span>Progreso: <span id="contador">0%</span></span>
      <div id="creditos-info">
        Créditos Totales: <span id="creditos-total">0</span>/330
      </div>
      <input id="buscador" type="text" placeholder="Buscar asignatura…"/>
      <select id="area-filter">
        <option value="">Todas Áreas</option>
        <option value="espiritual">Espiritual</option>
        <option value="general">General</option>
        <option value="profesional">Profesional</option>
        <option value="especialidad">Especialidad</option>
        <option value="practica">Práctica</option>
      </select>
      <!-- Nuevos botones para Exportar/Importar -->
      <button id="export-btn">Exportar Progreso</button>
      <input type="file" id="import-file" accept=".json" style="display: none;">
      <button id="import-btn">Importar Progreso</button>
      <button id="export-image-btn">Exportar Malla a PDF</button> <!-- Texto del botón actualizado -->
      <button onclick="reset()">Reiniciar</button>
      
      <!-- Sección de Información Combinada -->
      <details id="combined-info">
        <summary>Información de la Carrera</summary>
        <div>
          <ul>
            <li>Sede: Chillán</li>
            <li>Modalidad: Presencial</li>
            <li>Jornada: Diurna</li>
            <li>Arancel 2025: $5.346.000</li>
            <li>Matrícula: $275.000</li>
            <li>Código de postulación: 58202</li>
            <li>Duración: 11 Semestres</li>
          </ul>
        </div>
      </details>

      <div class="calc-box">
        <a href="https://calculatodo.com/calcular-promedio-ponderado-notas" target="_blank">
          Calcular mi nota para aprobar
        </a>
      </div>
      <div class="calc-box">
        <a href="https://escaladenotas.cl/" target="_blank">
          Calcular nota según puntaje
        </a>
      </div>
    </div>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <div id="content-wrapper">
    <!-- Barra lateral izquierda con Leyenda y Widgets -->
    <div id="left-sidebar">
      <!-- LEYENDA ÁREAS -->
      <div id="legend">
        <table>
          <tr><th>ÁREAS DE FORMACIÓN</th></tr>
          <tr><td><span class="dot area-espiritual"></span>Espiritual<span id="creditos-espiritual">0</span></td></tr>
          <tr><td><span class="dot area-general"></span>General<span id="creditos-general">0</span></td></tr>
          <tr><td><span class="dot area-profesional"></span>Profesional<span id="creditos-profesional">0</span></td></tr>
          <tr><td><span class="dot area-especialidad"></span>Especialidad<span id="creditos-especialidad">0</span></td></tr>
          <tr><td><span class="dot area-practica"></span>Práctica<span id="creditos-practica">0</span></td></tr>
        </table>
      </div>

      <!-- Panel de Widgets -->
      <div id="widgets-panel">
        <h3>Recursos Rápidos</h3>
        <div class="widget-card">
          <h4>Drive de la Carrera</h4>
          <a href="https://drive.google.com/drive/folders/1ts_jjP9MPqLo5sXeXgoDHL8_3fO_DXCm?hl=es" target="_blank">Acceder al Drive</a>
        </div>
        <div class="widget-card">
          <h4>Biblioteca UNACH</h4>
          <a href="https://biblioteca.unach.cl/basesdatossuscritas/" target="_blank">Ir a la Biblioteca</a>
        </div>
        <div class="widget-card">
          <h4>Google Académico</h4>
          <a href="https://scholar.google.es/?hl=es" target="_blank">Buscar Artículos</a>
        </div>
        <details class="widget-card" id="calendar-widget">
          <summary><h4>Calendario</h4></summary>
          <div id="calendar-content">
            <div id="calendar-header">
              <button id="prev-month">&lt;</button>
              <h5 id="current-month-year"></h5>
              <button id="next-month">&gt;</button>
            </div>
            <div id="calendar-grid">
              <div class="day-name">Lun</div>
              <div class="day-name">Mar</div>
              <div class="day-name">Mié</div>
              <div class="day-name">Jue</div>
              <div class="day-name">Vie</div>
              <div class="day-name">Sáb</div>
              <div class="day-name">Dom</div>
              <!-- Days will be generated here by JS -->
            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- MALLA -->
    <div id="malla-container">
      <div id="malla">
        <!-- Año 1 -->
        <div class="year" data-year="1">
          <div class="year-label">
            <span>1° AÑO</span>
            <div class="horas-sellos-btn">Horas sellos requeridas 25</div>
          </div>
          <div class="semestre" data-sem="1">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFCCR600" data-area="espiritual" data-creditos="2" data-desc="Estudio de la cosmovisión cristiana y su impacto en la vida y la ciencia.">
              <span class="dot area-espiritual"></span>Cosmovisión Cristiana y Revelación
            </div>
            <div class="ramo" data-code="QYFMPF600" data-area="profesional" data-creditos="5" data-desc="Fundamentos matemáticos esenciales para las ciencias farmacéuticas.">
              <span class="dot area-profesional"></span>Matemática para Farmacia
            </div>
            <div class="ramo" data-code="QYFMYE600" data-area="profesional" data-creditos="5" data-desc="Estudio de la morfología, histología y embriología humana.">
              <span class="dot area-profesional"></span>Morfohistología y Embriología
            </div>
            <div class="ramo" data-code="QYFQGE601" data-area="profesional" data-creditos="6" data-desc="Principios fundamentales de la química general.">
              <span class="dot area-profesional"></span>Química General I
            </div>
            <div class="ramo" data-code="QYFFPF600" data-area="profesional" data-creditos="5" data-desc="Conceptos de física aplicados a la farmacia.">
              <span class="dot area-profesional"></span>Física para Farmacia
            </div>
            <div class="ramo" data-code="QYFICF600" data-area="profesional" data-creditos="2" data-desc="Introducción a las Ciencias Farmacéuticas.">
              <span class="dot area-profesional"></span>Introducción a las Ciencias Farmacéuticas
            </div>
            <div class="ramo" data-code="QYFING601" data-area="general" data-creditos="2" data-desc="Desarrollo de habilidades básicas en el idioma inglés.">
              <span class="dot area-general"></span>Inglés I
            </div>
            <div class="ramo" data-code="QYFTAP601" data-area="general" data-creditos="3" data-desc="Taller para el desarrollo de habilidades de estudio y aprendizaje.">
              <span class="dot area-general"></span>Taller de Habilidades de Aprendizaje I
            </div>
          </div>
          <div class="semestre" data-sem="2">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFATB600" data-area="espiritual" data-creditos="2" data-desc="Análisis de la naturaleza humana desde una perspectiva bíblica.">
              <span class="dot area-espiritual"></span>Antropología Bíblica
            </div>
            <div class="ramo" data-code="QYFFQF600" data-req="QYFFPF600" data-area="profesional" data-creditos="5" data-desc="Estudio de los principios fisicoquímicos relevantes para la farmacia.">
              <span class="dot area-profesional"></span>Físicoquímica para Farmacia
            </div>
            <div class="ramo" data-code="QYFAPF600"  data-req="QYFMYE600" data-area="profesional" data-creditos="6" data-desc="Estudio de la anatomía humana aplicada a la farmacia.">
              <span class="dot area-profesional"></span>Anatomía para Farmacia
            </div>
            <div class="ramo" data-code="QYFQGE602" data-req="QYFQGE601" data-area="profesional" data-creditos="6" data-desc="Continuación de los principios de química general, con énfasis en reacciones.">
              <span class="dot area-profesional"></span>Química General II
            </div>
            <div class="ramo" data-code="QYFCYL600" data-area="general" data-creditos="3" data-desc="Desarrollo de habilidades de comunicación efectiva y liderazgo.">
              <span class="dot area-general"></span>Comunicación y Liderazgo
            </div>
            <div class="ramo" data-code="QYFGPF600"  data-req="QYFMYE600" data-area="profesional" data-creditos="3" data-desc="Principios de genética y su aplicación en farmacia.">
              <span class="dot area-profesional"></span>Genética para Farmacia
            </div>
            <div class="ramo" data-code="QYFING602" data-req="QYFING601" data-area="general" data-creditos="2" data-desc="Continuación del desarrollo de habilidades en inglés.">
              <span class="dot area-general"></span>Inglés II
            </div>
            <div class="ramo" data-code="QYFTAP602" data-area="general" data-creditos="3" data-desc="Taller avanzado de habilidades de aprendizaje y gestión del tiempo.">
              <span class="dot area-general"></span>Taller de Habilidades de Aprendizaje II
            </div>
          </div>
        </div>
        <!-- Año 2 -->
        <div class="year" data-year="2">
          <div class="year-label">
            <span>2° AÑO</span>
            <div class="horas-sellos-btn">Horas sellos requeridas 25</div>
          </div>
          <div class="semestre" data-sem="3">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFCRE600" data-area="espiritual" data-creditos="2" data-desc="Exploración de la relación entre la ciencia y la fe religiosa.">
              <span class="dot area-espiritual"></span>Ciencia y Religión
            </div>
            <div class="ramo" data-code="QYFBGF600" data-req="QYFMYE600" data-area="profesional" data-creditos="6" data-desc="Estudio de los procesos bioquímicos fundamentales para la farmacia.">
              <span class="dot area-profesional"></span>Bioquímica General para Farmacia
            </div>
            <div class="ramo" data-code="QYFFIF600" data-req="QYFAPF600" data-area="profesional" data-creditos="6" data-desc="Estudio de la fisiología de los sistemas del cuerpo humano.">
              <span class="dot area-profesional"></span>Fisiología para Farmacia
            </div>
            <div class="ramo" data-code="QYFQAN600"  data-req="QYFQGE602" data-area="profesional" data-creditos="6" data-desc="Principios y técnicas de la química analítica.">
              <span class="dot area-profesional"></span>Química Analítica
            </div>
            <div class="ramo" data-code="QYFQOR601" data-req="QYFQGE602" data-area="profesional" data-creditos="6" data-desc="Introducción a la química de compuestos orgánicos.">
              <span class="dot area-profesional"></span>Química Orgánica I
            </div>
            <div class="ramo" data-code="QYFITF600" data-req="QYFING602" data-area="general" data-creditos="3" data-desc="Desarrollo de habilidades de lectura y comprensión de textos técnicos en inglés.">
              <span class="dot area-general"></span>Inglés Técnico para Farmacia
            </div>
            <div class="ramo" data-code="QYFMIP600" data-area="profesional" data-creditos="3" data-desc="Estudio de microorganismos y parásitos de interés farmacéutico.">
              <span class="dot area-profesional"></span>Microbiología y Parasitología
            </div>
            <div class="ramo" data-code="QYFCMP601" data-area="general" data-creditos="1" data-desc="Asignatura complementaria de libre elección.">
              <span class="dot area-general"></span>Complementario I
            </div>
          </div>
          <div class="semestre" data-sem="4">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFEBI600" data-area="espiritual" data-creditos="2" data-desc="Profundización en las enseñanzas fundamentales de la Biblia.">
              <span class="dot area-espiritual"></span>Enseñanzas de la Biblia
            </div>
            <div class="ramo" data-code="QYFTNA610"  data-req="QYFFIF600" data-area="profesional" data-creditos="6" data-desc="Estudio de diversas terapias naturales y su aplicación.">
              <span class="dot area-profesional"></span>Terapias Naturales
            </div>
            <div class="ramo" data-code="QYFFPF610" data-req="QYFFIF600" data-area="profesional" data-creditos="6" data-desc="Estudio de los mecanismos de las enfermedades y sus manifestaciones.">
              <span class="dot area-profesional"></span>Fisiopatología para Farmacia
            </div>
            <div class="ramo" data-code="QYFAIM610" data-req="QYFQAN600" data-area="profesional" data-creditos="6" data-desc="Análisis de instrumentos y métodos para el control de calidad de medicamentos.">
              <span class="dot area-profesional"></span>Análisis Instrumental y de Medicamentos
            </div>
            <div class="ramo" data-code="QYFQOR602" data-req="QYFQOR601" data-area="profesional" data-creditos="6" data-desc="Continuación de la química orgánica, con énfasis en reacciones y síntesis.">
              <span class="dot area-profesional"></span>Química Orgánica II
            </div>
            <div class="ramo" data-code="QYFCMP602"  data-req="QYFCMP601" data-area="general" data-creditos="1" data-desc="Asignatura complementaria de libre elección.">
              <span class="dot area-general"></span>Complementario II
            </div>
          </div>
        </div>
        <!-- Año 3 -->
        <div class="year" data-year="3">
          <div class="year-label">
            <span>3° AÑO</span>
            <div class="horas-sellos-btn">Horas sellos requeridas 25</div>
          </div>
          <div class="semestre" data-sem="5">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFFYS600" data-area="espiritual" data-creditos="2" data-desc="Análisis de la estructura y dinámica de la familia y la sociedad.">
              <span class="dot area-espiritual"></span>Familia y Sociedad
            </div>
            <div class="ramo" data-code="QYFIYH600"  data-req="QYFFPF610" data-area="profesional" data-creditos="5" data-desc="Estudio del sistema inmune y los componentes de la sangre.">
              <span class="dot area-profesional"></span>Inmunología y Hematología
            </div>
            <div class="ramo" data-code="QYFLFA600" data-req="QYFICF600" data-area="especialidad" data-creditos="4" data-desc="Marco legal que rige la actividad farmacéutica y la autoridad sanitaria.">
              <span class="dot area-especialidad"></span>Legislación Farmacéutica y Autorización Sanitaria
            </div>
            <div class="ramo" data-code="QYFFAQ601" data-req="QYFFQF600,QYFQOR602" data-area="profesional" data-creditos="6" data-desc="Estudio de la relación entre la estructura química y la actividad biológica de los fármacos.">
              <span class="dot area-profesional"></span>Farmacoquímica I
            </div>
            <div class="ramo" data-code="QYFFAR611"  data-req="QYFFPF610" data-area="profesional" data-creditos="6" data-desc="Introducción a los principios de la farmacología y acción de los fármacos.">
              <span class="dot area-profesional"></span>Farmacología I
            </div>
            <div class="ramo" data-code="QYFTFA601" data-req="QYFQOR602" data-area="profesional" data-creditos="6" data-desc="Principios de formulación y producción de formas farmacéuticas.">
              <span class="dot area-profesional"></span>Tecnología Farmacéutica I
            </div>
            <div class="ramo" data-code="QYFCMP603"  data-req="QYFCMP602" data-area="general" data-creditos="1" data-desc="Asignatura complementaria de libre elección.">
              <span class="dot area-general"></span>Complementario III
            </div>
          </div>
          <div class="semestre" data-sem="6">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFSRS600" data-area="general" data-creditos="2" data-desc="Importancia del autocuidado, responsabilidad social y medioambiente.">
              <span class="dot area-general"></span>Salud y Autocuidado, Responsabilidad Social y Medioambiente
            </div>
            <div class="ramo" data-code="QYFBQC600"  data-req="QYFBGF600" data-area="profesional" data-creditos="4" data-desc="Aplicación de la bioquímica en el diagnóstico y seguimiento clínico.">
              <span class="dot area-profesional"></span>Bioquímica Clínica
            </div>
            <div class="ramo" data-code="QYFNBC600" data-area="profesional" data-creditos="5" data-desc="Estudio de la nutrición y el análisis de alimentos en el contexto clínico.">
              <span class="dot area-profesional"></span>Nutrición y Bromatología Clínicas
            </div>
            <div class="ramo" data-code="QYFFAR612"  data-req="QYFFAR611" data-area="profesional" data-creditos="6" data-desc="Profundización en la farmacología de diferentes sistemas orgánicos.">
              <span class="dot area-profesional"></span>Farmacología II
            </div>
            <div class="ramo" data-code="QYFFAQ602" data-req="QYFFAQ601" data-area="profesional" data-creditos="6" data-desc="Continuación del estudio de la relación estructura-actividad de los fármacos.">
              <span class="dot area-profesional"></span>Farmacoquímica II
            </div>
            <div class="ramo" data-code="QYFTFA602" data-req="QYFTFA601" data-area="profesional" data-creditos="6" data-desc="Formulación y evaluación de formas farmacéuticas avanzadas.">
              <span class="dot area-profesional"></span>Tecnología Farmacéutica II
            </div>
            <div class="ramo" data-code="QYFCMP604"  data-req="QYFCMP603" data-area="general" data-creditos="1" data-desc="Asignatura complementaria de libre elección.">
              <span class="dot area-general"></span>Complementario IV
            </div>
          </div>
        </div>
        <!-- Año 4 -->
        <div class="year" data-year="4">
          <div class="year-label">
            <span>4° AÑO</span>
            <div class="horas-sellos-btn">Horas sellos requeridas 25</div>
          </div>
          <div class="semestre" data-sem="7">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFMYS600" data-area="espiritual" data-creditos="2" data-desc="Principios de misión y servicio en el contexto cristiano.">
              <span class="dot area-espiritual"></span>Misión y Servicio
            </div>
            <div class="ramo" data-code="QYFMIF600" data-area="profesional" data-creditos="3" data-desc="Diseño y ejecución de proyectos de investigación en farmacia.">
              <span class="dot area-profesional"></span>Metodología de la Investigación para Farmacia
            </div>
            <div class="ramo" data-code="QYFTOX600"  data-req="QYFFAR612" data-area="especialidad" data-creditos="6" data-desc="Estudio de los efectos tóxicos de sustancias y su manejo.">
              <span class="dot area-especialidad"></span>Toxicología
            </div>
            <div class="ramo" data-code="QYFFCA600" data-req="QYFFAR612" data-area="especialidad" data-creditos="5" data-desc="Rol del farmacéutico en la comunidad y atención asistencial.">
              <span class="dot area-especialidad"></span>Farmacia Comunitaria y Asistencial
            </div>
            <div class="ramo" data-code="QYFFGN600" data-area="especialidad" data-creditos="5" data-desc="Estudio de fármacos de origen natural.">
              <span class="dot area-especialidad"></span>Farmacognosia
            </div>
            <div class="ramo" data-code="QYFTCO600"  data-req="QYFTFA602" data-area="profesional" data-creditos="5" data-desc="Principios y formulación de productos cosméticos.">
              <span class="dot area-profesional"></span>Tecnología Cosmética
            </div>
            <div class="ramo" data-code="QYFPLC600" data-req="QYFIYH600,QYFMIP600" data-area="practica" data-creditos="4" data-desc="Práctica en laboratorio clínico, realizando análisis y diagnósticos.">
              <span class="dot area-practica"></span>Práctica Laboratorio Clínico
            </div>
          </div>
          <div class="semestre" data-sem="8">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFEVP600" data-area="espiritual" data-creditos="2" data-desc="Análisis de la ética y valores en el ejercicio profesional.">
              <span class="dot area-espiritual"></span>Ética y Vida Profesional
            </div>
            <div class="ramo" data-code="QYFBEA600" data-area="profesional" data-creditos="4" data-desc="Aplicación de métodos estadísticos en la investigación farmacéutica.">
              <span class="dot area-profesional"></span>Bioestadística Aplicada
            </div>
            <div class="ramo" data-code="QYFFVT600" data-req="QYFLFA600" data-area="especialidad" data-creditos="4" data-desc="Sistemas de vigilancia de la seguridad de medicamentos y tecnologías.">
              <span class="dot area-especialidad"></span>Farmacovigilancia y Tecnovigilancia
            </div>
            <div class="ramo" data-code="QYFFCL601" data-req="QYFFCA600" data-area="especialidad" data-creditos="6" data-desc="Aplicación de conocimientos farmacológicos en casos clínicos.">
              <span class="dot area-especialidad"></span>Farmacia Clínica I
            </div>
            <div class="ramo" data-code="QYFSPE600" data-req="QYFMIP600" data-area="profesional" data-creditos="5" data-desc="Principios de salud pública y epidemiología.">
              <span class="dot area-profesional"></span>Salud Pública y Epidemiología
            </div>
            <div class="ramo" data-code="QYFCCA610"  data-req="QYFTCO600" data-area="profesional" data-creditos="5" data-desc="Métodos y normas para el control de calidad de productos farmacéuticos.">
              <span class="dot area-profesional"></span>Control de Calidad
            </div>
            <div class="ramo" data-code="QYFPFP600" data-req="QYFFCA600" data-area="practica" data-creditos="4" data-desc="Práctica profesional en farmacias privadas.">
              <span class="dot area-practica"></span>Práctica Farmacia Privada
            </div>
          </div>
        </div>
        <!-- Año 5 -->
        <div class="year" data-year="5">
          <div class="year-label">
            <span>5° AÑO</span>
            <div class="horas-sellos-btn">Horas sellos requeridas 25</div>
          </div>
          <div class="semestre" data-sem="9">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFEDF610" data-area="especialidad" data-creditos="2" data-desc="Asignatura electiva para profundizar en un área específica de la farmacia.">
              <span class="dot area-especialidad"></span>Electivo de Farmacia
            </div>
            <div class="ramo" data-code="QYFFCP600" data-area="profesional" data-creditos="3" data-desc="Análisis económico de medicamentos y procesos de compra pública.">
              <span class="dot area-profesional"></span>Farmacoeconomía y Compras Públicas
            </div>
            <div class="ramo" data-code="QYFFCA610" data-req="QYFFCL601" data-area="especialidad" data-creditos="6" data-desc="Aplicación de la farmacocinética en la práctica clínica.">
              <span class="dot area-especialidad"></span>Farmacocinética Aplicada
            </div>
            <div class="ramo" data-code="QYFAFS600" data-req="QYFFCL602" data-area="especialidad" data-creditos="6" data-desc="Seguimiento farmacoterapéutico y atención farmacéutica personalizada.">
              <span class="dot area-especialidad"></span>Atención Farmacéutica y Seguimiento Farmacológico
            </div>
            <div class="ramo" data-code="QYFFCL602" data-req="QYFFCL601" data-area="especialidad" data-creditos="6" data-desc="Casos clínicos avanzados y manejo de terapias farmacológicas.">
              <span class="dot area-especialidad"></span>Farmacia Clínica II
            </div>
            <div class="ramo" data-code="QYFFGE600" data-req="QYFFCL602" data-area="especialidad" data-creditos="4" data-desc="Manejo farmacológico en pacientes geriátricos.">
              <span class="dot area-especialidad"></span>Farmacogeriatría
            </div>
            <div class="ramo" data-code="QYFOCP600" data-req="QYFFCL601" data-area="especialidad" data-creditos="5" data-desc="Manejo farmacológico en oncología y cuidados paliativos.">
              <span class="dot area-especialidad"></span>Oncoterapia y Cuidados Paliativos
            </div>
            <div class="ramo" data-code="QYFSME600" data-area="profesional" data-creditos="4" data-desc="Introducción a la salud mental y su relación con la farmacología.">
              <span class="dot area-profesional"></span>Salud Mental
            </div>
            <div class="ramo" data-code="QYFPFC600" data-req="QYFPFP600" data-area="practica" data-creditos="4" data-desc="Práctica en farmacias comunitarias y atención primaria de salud.">
              <span class="dot area-practica"></span>Práctica en Farmacia Comunitaria APS
            </div>
          </div>
          <div class="semestre" data-sem="10">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFTFC641" data-req="QYFMIF600" data-area="profesional" data-creditos="7" data-desc="Taller de Formulación y Control de Calidad I.">
              <span class="dot area-profesional"></span>TFC I
            </div>
            <div class="ramo" data-code="QYFTFC642" data-req="QYFTFC641" data-area="profesional" data-creditos="9" data-desc="Taller de Formulación y Control de Calidad II.">
              <span class="dot area-profesional"></span>TFC II
            </div>
            <div class="ramo" data-code="QYFPFA610" data-req="QYFPLC600" data-area="practica" data-creditos="4" data-desc="Práctica profesional en farmacias asistenciales (hospitales, clínicas).">
              <span class="dot area-practica"></span>Práctica Farmacia Asistencial
            </div>
          </div>
        </div>
        <!-- Año 6 -->
        <div class="year" data-year="6">
          <div class="year-label">
            <span>6° AÑO</span>
            <div class="horas-sellos-btn">Horas sellos requeridas 25</div>
          </div>
          <div class="semestre" data-sem="11">
            <div class="progress"><div class="progress-fill"></div></div>
            <div class="ramo" data-code="QYFPRO636" data-req="QYFAFS600,QYFFCA610,QYFFCP600,QYFFGE600,QYFOCP600,QYFPFA610,QYFSME600,QYFTFC642" data-area="practica" data-creditos="30" data-desc="Práctica profesional intensiva en un entorno farmacéutico.">
              <span class="dot area-practica"></span>Práctica Profesional/Internado
            </div>
          </div>
          <div class="semestre empty"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Información de Ramo -->
  <div id="ramo-info-modal" class="modal-backdrop">
    <div class="modal-content">
      <button class="modal-close-button">&times;</button>
      <h3 class="modal-title" id="modal-ramo-nombre"></h3>
      <div class="modal-info">
        <p><strong>Código:</strong> <span id="modal-ramo-code"></span></p>
        <p><strong>Área:</strong> <span id="modal-ramo-area"></span></p>
        <p><strong>Créditos:</strong> <span id="modal-ramo-creditos"></span></p>
        <p><strong>Prerrequisitos:</strong> <span id="modal-ramo-req"></span></p>
        <p><strong>Descripción:</strong> <span id="modal-ramo-desc"></span></p>
      </div>
      <div class="modal-buttons">
        <button id="modal-btn-aprobado" class="btn-aprobado">Marcar como Aprobado</button>
        <button id="modal-btn-desmarcar" class="btn-desmarcar">Desmarcar</button>
        <button id="modal-btn-close" class="btn-close">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmación Personalizado (para Reiniciar) -->
  <div id="custom-confirm-modal" class="modal-backdrop custom-confirm-modal">
    <div class="modal-content">
      <h3 class="modal-title">Reiniciar Progreso</h3>
      <p>¿Estás seguro de que quieres reiniciar todo el progreso? Esto no se puede deshacer.</p>
      <div class="modal-buttons">
        <button id="confirm-reset-yes" class="btn-desmarcar">Sí, reiniciar</button>
        <button id="confirm-reset-no" class="btn-close">No, cancelar</button>
      </div>
    </div>
  </div>

  <!-- Nuevo Modal para el Mensaje del Tr._nico -->
  <div id="tr-nico-message-modal" class="modal-backdrop custom-alert-modal">
    <div class="modal-content">
      <button class="modal-close-button">&times;</button>
      <h3 class="modal-title">Mensaje Especial</h3>
      <p>Regalito del tr._nico para mis compañeros químicos farmacéuticos.</p>
      <div class="modal-buttons">
        <button class="btn-close" id="tr-nico-modal-close-btn">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Nuevo Modal de Felicidades por Semestre Completado -->
  <div id="semester-complete-modal" class="modal-backdrop">
    <div class="modal-content">
      <h3 class="modal-title">¡FELICIDADES!</h3>
      <p id="semester-complete-message"></p>
      <div class="modal-buttons">
        <button class="btn-close" id="semester-complete-modal-close-btn">¡Entendido!</button>
      </div>
    </div>
  </div>

  <!-- Script para jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Referencias a los elementos del DOM
    const ramos = document.querySelectorAll('.ramo'),
          get   = k=>JSON.parse(localStorage.getItem(k))||[], // Obtiene datos del localStorage
          set   = (k,v)=>localStorage.setItem(k,JSON.stringify(v)), // Guarda datos en el localStorage
          busc  = document.getElementById('buscador'),
          areaF = document.getElementById('area-filter'),
          zoomR = document.getElementById('zoom'),
          clk   = document.getElementById('clock'),
          themeSelector = document.getElementById('theme-selector'),
          container = document.getElementById('malla-container');

    // Referencias a elementos del modal de información de ramo
    const ramoInfoModal = document.getElementById('ramo-info-modal');
    const modalRamoNombre = document.getElementById('modal-ramo-nombre');
    const modalRamoCode = document.getElementById('modal-ramo-code');
    const modalRamoArea = document.getElementById('modal-ramo-area');
    const modalRamoCreditos = document.getElementById('modal-ramo-creditos');
    const modalRamoReq = document.getElementById('modal-ramo-req');
    const modalRamoDesc = document.getElementById('modal-ramo-desc');
    const modalBtnAprobado = document.getElementById('modal-btn-aprobado');
    const modalBtnDesmarcar = document.getElementById('modal-btn-desmarcar');
    const modalCloseButton = ramoInfoModal.querySelector('.modal-close-button');
    const modalBtnClose = document.getElementById('modal-btn-close');

    // Referencias a elementos del modal de confirmación personalizado
    const customConfirmModal = document.getElementById('custom-confirm-modal');
    const confirmResetYes = document.getElementById('confirm-reset-yes');
    const confirmResetNo = document.getElementById('confirm-reset-no');

    // Referencias a elementos de créditos (ahora en la leyenda)
    const creditosTotalSpan = document.getElementById('creditos-total');
    const creditosEspiritualSpan = document.getElementById('creditos-espiritual');
    const creditosGeneralSpan = document.getElementById('creditos-general');
    const creditosProfesionalSpan = document.getElementById('creditos-profesional');
    const creditosEspecialidadSpan = document.getElementById('creditos-especialidad');
    const creditosPracticaSpan = document.getElementById('creditos-practica');

    // Nuevas referencias para el botón y modal del mensaje del tr._nico
    const trNicoInfoBtn = document.getElementById('tr-nico-info-btn');
    const trNicoMessageModal = document.getElementById('tr-nico-message-modal');
    const trNicoModalCloseBtn = document.getElementById('tr-nico-modal-close-btn');
    const trNicoMessageModalCloseButton = trNicoMessageModal.querySelector('.modal-close-button');

    // Nuevas referencias para los botones de Exportar/Importar
    const exportBtn = document.getElementById('export-btn');
    const importBtn = document.getElementById('import-btn');
    const importFile = document.getElementById('import-file');
    const exportImageBtn = document.getElementById('export-image-btn'); // Nuevo botón de exportar imagen

    // Nuevas referencias para el modal de semestre completado
    const semesterCompleteModal = document.getElementById('semester-complete-modal');
    const semesterCompleteMessage = document.getElementById('semester-complete-message');
    const semesterCompleteModalCloseBtn = document.getElementById('semester-complete-modal-close-btn');

    // Calendar elements
    const calendarWidget = document.getElementById('calendar-widget');
    const calendarHeader = document.getElementById('calendar-header');
    const currentMonthYear = document.getElementById('current-month-year');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const calendarGrid = document.getElementById('calendar-grid');

    // Variables de estado
    let aprobados = new Set(get('aprobados')), // Conjunto de ramos aprobados
        totalRamos = ramos.length, // Total de ramos en la malla
        completedSem = new Set(get('completedSem')), // Semestres completados (para alertas), cargado de localStorage
        completedYear = new Set(get('completedYear')); // Años completados (para alertas), cargado de localStorage

    let currentCalendarDate = new Date(); // Current date for the calendar

    // Función para actualizar el reloj en el encabezado
    function updateClock(){
      const now = new Date();
      const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
      clk.textContent = now.toLocaleDateString('es-ES', options);
    }
    // Actualiza el reloj cada segundo
    setInterval(updateClock,1000);
    updateClock(); // Llama una vez al inicio para mostrar la hora inmediatamente

    // Lógica para el cambio de tema (múltiples temas)
    // Carga el estado del tema al iniciar la página desde localStorage
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.classList.add(savedTheme);
    themeSelector.value = savedTheme;

    // Escucha el evento de cambio del selector para alternar el tema
    themeSelector.addEventListener('change', (e)=>{
      // Elimina todas las clases de tema existentes
      document.body.classList.remove('light', 'dark', 'pastel', 'celeste', 'rosado', 'verde');
      // Añade la nueva clase de tema
      document.body.classList.add(e.target.value);
      localStorage.setItem('theme', e.target.value);
    });

    // Lógica para el zoom de la malla
    zoomR.addEventListener('input', e=>{
      container.style.transform = `scale(${e.target.value/100})`;
    });
    // Aplica el zoom inicial al cargar la página
    container.style.transform = `scale(${zoomR.value/100})`;

    // Función para desmarcar ramos en cascada (si un prerequisito es desmarcado)
    function cascadeRemove(code){
      aprobados.delete(code); // Elimina el ramo actual del conjunto de aprobados
      ramos.forEach(r=>{
        const deps = r.dataset.req ? r.dataset.req.split(',') : [];
        // Si este ramo depende del ramo desmarcado y también está aprobado, desmárcalo en cascada
        if(deps.includes(code) && aprobados.has(r.dataset.code))
          cascadeRemove(r.dataset.code);
      });
    }

    // Función principal para actualizar la interfaz de usuario
    function updateUI(){
      let approvedCount = 0; // Contador de ramos aprobados globalmente
      let totalCreditosAprobados = 0;
      let creditosPorArea = {
          espiritual: 0,
          general: 0,
          profesional: 0,
          especialidad: 0,
          practica: 0
      };

      // Itera sobre cada semestre para actualizar su progreso y estado de los ramos
      document.querySelectorAll('.semestre').forEach(s=>{
        const hijos = s.querySelectorAll('.ramo'); // Todos los ramos en el semestre
        const prog  = s.querySelector('.progress-fill'); // La barra de progreso del semestre

        // Verifica si la barra de progreso existe antes de intentar acceder a su estilo
        if (!prog) {
            return; // Salta este semestre si no tiene una barra de progreso (ej. semestres vacíos)
        }

        let aproS = 0; // Contador de ramos aprobados en el semestre actual

        hijos.forEach(r=>{
          const code = r.dataset.code, // Código del ramo
                deps = r.dataset.req ? r.dataset.req.split(',') : []; // Prerequisitos del ramo
          r.classList.remove('aprobado','desbloqueado','highlight'); // Limpia classes de animación

          if(aprobados.has(code)){
            r.classList.add('aprobado'); // Marca como aprobado
            aproS++; // Incrementa el contador de aprobados del semestre

            // Sumar créditos para el total y por área
            const creditos = parseInt(r.dataset.creditos);
            const area = r.dataset.area;
            if (!isNaN(creditos)) {
                totalCreditosAprobados += creditos;
                if (creditosPorArea[area] !== undefined) {
                    creditosPorArea[area] += creditos;
                }
            }
          } else if(deps.length > 0 && deps.every(q => aprobados.has(q))){
            // Check if it was previously unlocked to avoid re-triggering animation on every UI update
            const wasUnlocked = r.classList.contains('desbloqueado');
            r.classList.add('desbloqueado'); // Marca como desbloqueado si los prerequisitos están aprobados
            if (!wasUnlocked) {
                // Re-apply animation if it just became unlocked
                r.style.animation = 'none';
                void r.offsetWidth; // Trigger reflow
                r.style.animation = null;
            }
          }
        });

        // Actualiza la barra de progreso del semestre
        if (hijos.length > 0) {
            prog.style.width = (aproS / hijos.length * 100) + '%';
        } else {
            prog.style.width = '0%'; // Si no hay ramos, el progreso es 0
        }

        const sem = s.dataset.sem;
        // Muestra una alerta si el semestre está completo y no se ha alertado antes
        if(aproS === hijos.length && hijos.length > 0 && !completedSem.has(sem)){
          showSemesterCompleteModal(`¡Felicidades, sobreviviste al ${sem}° semestre!`);
          completedSem.add(sem);
          set('completedSem', [...completedSem]); // Guarda el estado actualizado
        }
      });

      // Recalcula el contador global de progreso de la malla
      approvedCount = aprobados.size;
      document.getElementById('contador').textContent = Math.round(approvedCount / totalRamos * 100) + '%';

      // Actualizar los créditos en la UI
      creditosTotalSpan.textContent = totalCreditosAprobados;
      creditosEspiritualSpan.textContent = creditosPorArea.espiritual;
      creditosGeneralSpan.textContent = creditosPorArea.general;
      creditosProfesionalSpan.textContent = creditosPorArea.profesional;
      creditosEspecialidadSpan.textContent = creditosPorArea.especialidad;
      creditosPracticaSpan.textContent = creditosPorArea.practica;


      // Itera sobre cada año para verificar si está completo
      document.querySelectorAll('.year').forEach(y=>{
        const year = y.dataset.year;
        if(year){
          const sems = y.querySelectorAll('.semestre:not(.empty)'), // Semestres del año (excluyendo los vacíos)
                // Verifica si todos los semestres del año tienen el 100% de progreso
                allSemestersComplete  = [...sems].every(s=>
                  parseFloat(s.querySelector('.progress-fill').style.width) === 100);
          // Si el año está completo y no se ha alertado antes
          if(allSemestersComplete && !completedYear.has(year)){
            y.setAttribute('data-year-complete',''); // Añade un atributo para el estilo visual
            showSemesterCompleteModal(`¡Felicidades, completaste el ${year}° año!`);
            completedYear.add(year);
            set('completedYear', [...completedYear]); // Guarda el estado actualizado
          }
        }
      });
    }

    // Función para mostrar un modal de alerta personalizado (se mantiene el alert() por ahora)
    // NOTA: Esta función ya no se usa para completar semestre/año, ahora se usa showSemesterCompleteModal
    function showCustomAlert(message) {
        // Reemplazando alert() con un modal personalizado para mejor UX
        const customAlertModal = document.getElementById('tr-nico-message-modal'); // Reutilizando este modal
        const modalTitle = customAlertModal.querySelector('.modal-title');
        const modalMessage = customAlertModal.querySelector('p');
        
        modalTitle.textContent = "Información"; // Título genérico para alertas
        modalMessage.textContent = message;
        customAlertModal.classList.add('show');

        // Cerrar el modal al hacer clic en el botón o fuera de él
        const closeBtn = customAlertModal.querySelector('.modal-close-button');
        const okBtn = customAlertModal.querySelector('#tr-nico-modal-close-btn');
        const closeHandler = () => {
            customAlertModal.classList.remove('show');
            closeBtn.removeEventListener('click', closeHandler);
            okBtn.removeEventListener('click', closeHandler);
            customAlertModal.removeEventListener('click', backdropCloseHandler);
        };
        const backdropCloseHandler = (e) => {
            if (e.target === customAlertModal) {
                closeHandler();
            }
        };
        closeBtn.addEventListener('click', closeHandler);
        okBtn.addEventListener('click', closeHandler);
        customAlertModal.addEventListener('click', backdropCloseHandler);
    }

    // Función para mostrar el modal de información del ramo
    let currentRamoElement = null; // Para almacenar el elemento del ramo que abrió el modal

    function showRamoInfoModal(ramoElement) {
        currentRamoElement = ramoElement; // Guarda el elemento del ramo actual

        const code = ramoElement.dataset.code;
        const nombre = ramoElement.textContent.trim();
        const area = ramoElement.dataset.area;
        const creditos = ramoElement.dataset.creditos || 'N/A';
        const prerequisitos = ramoElement.dataset.req ? ramoElement.dataset.req.split(',').map(reqCode => {
            const reqRamo = document.querySelector(`.ramo[data-code="${reqCode}"]`);
            return reqRamo ? reqRamo.textContent.trim() : reqCode;
        }).join(', ') : 'Ninguno';
        const descripcion = ramoElement.dataset.desc || 'No hay descripción disponible.';

        modalRamoNombre.textContent = nombre;
        modalRamoCode.textContent = code;
        modalRamoArea.textContent = area.charAt(0).toUpperCase() + area.slice(1); // Capitalizar la primera letra
        modalRamoCreditos.textContent = creditos;
        modalRamoReq.textContent = prerequisitos;
        modalRamoDesc.textContent = descripcion;

        // Actualizar el estado de los botones de aprobar/desmarcar
        if (aprobados.has(code)) {
            modalBtnAprobado.style.display = 'none';
            modalBtnDesmarcar.style.display = 'inline-block';
        } else {
            modalBtnAprobado.style.display = 'inline-block';
            modalBtnDesmarcar.style.display = 'none';
        }

        ramoInfoModal.classList.add('show');
    }

    // Función para ocultar el modal de información del ramo
    function hideRamoInfoModal() {
        ramoInfoModal.classList.remove('show');
        currentRamoElement = null; // Limpia la referencia al ramo
    }

    // Manejador de clic en un ramo
    ramos.forEach(r=> r.onclick=()=>{
      showRamoInfoModal(r); // Abre el modal de información del ramo
    });

    // Event listeners para los botones del modal de información del ramo
    modalCloseButton.addEventListener('click', hideRamoInfoModal);
    modalBtnClose.addEventListener('click', hideRamoInfoModal);
    ramoInfoModal.addEventListener('click', (e) => {
        if (e.target === ramoInfoModal) { // Solo cierra si se hace clic en el fondo
            hideRamoInfoModal();
        }
    });

    modalBtnAprobado.addEventListener('click', () => {
        if (currentRamoElement) {
            const code = currentRamoElement.dataset.code;
            const deps = currentRamoElement.dataset.req ? currentRamoElement.dataset.req.split(',') : [];

            if (deps.length > 0 && !deps.every(q => aprobados.has(q))) {
                const falt = deps.find(q => !aprobados.has(q));
                const nom = document.querySelector(`.ramo[data-code="${falt}"]`).textContent;
                currentRamoElement.classList.add('error');
                showCustomAlert(`Lo siento, aún no has aprobado "${nom.trim()}" para aprobar este ramo.`);
                currentRamoElement.addEventListener('animationend', () => currentRamoElement.classList.remove('error'), { once: true });
            } else {
                aprobados.add(code);
                set('aprobados', [...aprobados]);
                updateUI();
                hideRamoInfoModal();
            }
        }
    });

    modalBtnDesmarcar.addEventListener('click', () => {
        if (currentRamoElement) {
            const code = currentRamoElement.dataset.code;
            cascadeRemove(code);
            set('aprobados', [...aprobados]);
            updateUI();
            hideRamoInfoModal();
        }
    });


    // Funciones para el buscador y filtro por área
    const normalize = s=> s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); // Normaliza texto
    function filterRamos(){
      const q    = normalize(busc.value), // Valor del buscador normalizado
            area = areaF.value; // Valor del filtro de área
      ramos.forEach(r=>{
        const txt = normalize(r.textContent), // Texto del ramo normalizado
              a   = r.dataset.area; // Área del ramo
        // Muestra u oculta el ramo según el filtro y el buscador
        if((!q||txt.includes(q)) && (!area||a===area)){
          r.style.display='';
          // Añade o quita la clase 'highlight' si hay un filtro aplicado
          if(q !== '' || area !== '') {
              r.classList.add('highlight');
          } else {
              r.classList.remove('highlight');
          }
        } else {
          r.style.display='none';
          r.classList.remove('highlight');
        }
      });
    }
    // Escucha eventos de input y cambio para aplicar los filtros
    busc.addEventListener('input',filterRamos);
    areaF.addEventListener('change',filterRamos);

    // Función para mostrar el modal de confirmación personalizado
    let confirmCallback = null; // Para almacenar la función a ejecutar si se confirma

    function showCustomConfirm(message, onConfirm) {
        // El mensaje ya está fijo en el HTML para este modal específico
        customConfirmModal.classList.add('show');
        confirmCallback = onConfirm; // Guarda la función de callback
    }

    function hideCustomConfirm() {
        customConfirmModal.classList.remove('show');
        confirmCallback = null; // Limpia el callback
    }

    // Manejador de clic para el botón "Reiniciar"
    function reset(){
      showCustomConfirm('¿Estás seguro de que quieres reiniciar todo el progreso? Esto no se puede deshacer.', () => {
        localStorage.removeItem('aprobados'); // Elimina los datos de aprobados
        localStorage.removeItem('completedSem'); // Elimina semestres completados
        localStorage.removeItem('completedYear'); // Elimina años completados
        aprobados.clear(); // Limpia el conjunto de aprobados
        completedSem.clear(); // Limpia los semestres completados
        completedYear.clear(); // Limpia los años completados
        document.querySelectorAll('.year').forEach(y => y.removeAttribute('data-year-complete')); // Quita el atributo visual de año completo
        updateUI(); // Actualiza la interfaz de usuario
        hideCustomConfirm();
      });
    }

    // Event listeners para los botones del modal de confirmación
    confirmResetYes.addEventListener('click', () => {
        if (confirmCallback) {
            confirmCallback();
        }
    });

    confirmResetNo.addEventListener('click', hideCustomConfirm);

    customConfirmModal.addEventListener('click', (e) => {
        if (e.target === customConfirmModal) {
            hideCustomConfirm();
        }
    });

    // Funciones para el nuevo modal del mensaje del tr._nico
    function showTrNicoMessageModal() {
        trNicoMessageModal.classList.add('show');
    }

    function hideTrNicoMessageModal() {
        trNicoMessageModal.classList.remove('show');
    }

    // Event listeners para el botón y el modal del mensaje del tr._nico
    trNicoInfoBtn.addEventListener('click', showTrNicoMessageModal);
    trNicoModalCloseBtn.addEventListener('click', hideTrNicoMessageModal);
    trNicoMessageModalCloseButton.addEventListener('click', hideTrNicoMessageModal);
    trNicoMessageModal.addEventListener('click', (e) => {
        if (e.target === trNicoMessageModal) {
            hideTrNicoMessageModal();
        }
    });

    // Funciones para el modal de semestre completado
    function showSemesterCompleteModal(message) {
        semesterCompleteMessage.textContent = message;
        semesterCompleteModal.classList.add('show');
    }

    function hideSemesterCompleteModal() {
        semesterCompleteModal.classList.remove('show');
    }

    semesterCompleteModalCloseBtn.addEventListener('click', hideSemesterCompleteModal);
    semesterCompleteModal.addEventListener('click', (e) => {
        if (e.target === semesterCompleteModal) {
            hideSemesterCompleteModal();
        }
    });


    // Funciones de Exportar/Importar Progreso
    exportBtn.addEventListener('click', () => {
        const dataToExport = {
            aprobados: [...aprobados],
            theme: localStorage.getItem('theme') || 'light', // Exportar el tema actual
            completedSem: [...completedSem], // Exportar semestres completados
            completedYear: [...completedYear] // Exportar años completados
        };
        const dataStr = JSON.stringify(dataToExport); // Convierte el Set a Array y luego a String JSON
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'progreso_malla_unach.json';
        document.body.appendChild(a); // Necesario para Firefox
        a.click();
        document.body.removeChild(a); // Limpiar
        URL.revokeObjectURL(url); // Liberar el objeto URL
        showCustomAlert('Progreso exportado exitosamente como "progreso_malla_unach.json"');
    });

    importBtn.addEventListener('click', () => {
        importFile.click(); // Simula el clic en el input de tipo file
    });

    importFile.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData && importedData.aprobados && Array.isArray(importedData.aprobados)) {
                    aprobados = new Set(importedData.aprobados);
                    set('aprobados', [...aprobados]);
                    
                    // Importar semestres y años completados
                    completedSem = new Set(importedData.completedSem || []);
                    set('completedSem', [...completedSem]);
                    completedYear = new Set(importedData.completedYear || []);
                    set('completedYear', [...completedYear]);

                    document.querySelectorAll('.year').forEach(y => y.removeAttribute('data-year-complete'));

                    // Importar tema si está presente en los datos
                    if (importedData.theme) {
                        document.body.classList.remove('light', 'dark', 'pastel', 'celeste', 'rosado', 'verde');
                        document.body.classList.add(importedData.theme);
                        themeSelector.value = importedData.theme;
                        localStorage.setItem('theme', importedData.theme);
                    }

                    updateUI();
                    showCustomAlert('Progreso importado exitosamente.');
                } else {
                    showCustomAlert('El archivo importado no tiene el formato correcto.');
                }
            } catch (error) {
                console.error('Error al parsear el archivo JSON:', error);
                showCustomAlert('Error al importar el progreso. Asegúrate de que el archivo sea un JSON válido.');
            }
        };
        reader.readAsText(file);
    });

    // Function to create a dot with specific area color for PDF export
    const createPdfDotColor = (area, bodyStyle) => {
        switch (area) {
            case 'espiritual': return 'green';
            case 'general': return '#00bcd4';
            case 'profesional': return bodyStyle.getPropertyValue('--yellow');
            case 'especialidad': return bodyStyle.getPropertyValue('--lila');
            case 'practica': return bodyStyle.getPropertyValue('--red');
            default: return '#000000'; // Default black
        }
    };

    // Image export functionality (now PDF export)
    exportImageBtn.addEventListener('click', async () => {
        const originalButtonText = exportImageBtn.textContent;
        exportImageBtn.textContent = 'Generando PDF...';
        exportImageBtn.disabled = true;

        const totalCreditsText = `Créditos Totales: ${creditosTotalSpan.textContent}/330`;
        const currentThemeDisplay = themeSelector.options[themeSelector.selectedIndex].text;
        const currentDateTime = clk.textContent;

        const bodyStyle = getComputedStyle(document.body);
        const accentColor = bodyStyle.getPropertyValue('--accent');
        const accent2Color = bodyStyle.getPropertyValue('--accent2');
        const textColor = bodyStyle.getPropertyValue('--text');
        const cardColor = bodyStyle.getPropertyValue('--card');
        const ramoBgColor = bodyStyle.getPropertyValue('--ramo-bg');
        const ramoAprobadoBgColor = bodyStyle.getPropertyValue('--ramo-aprobado-bg');
        const greenColor = bodyStyle.getPropertyValue('--green');

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 10;
            let currentY = margin;

            // Header content
            const headerHeight = 30; // Height for the header section
            const logoSize = 15; // Smaller logo for PDF
            const logoX = margin;
            const logoY = currentY + (headerHeight - logoSize) / 2 - 2; // Centered vertically in header

            // Placeholder for logo image (as direct file access is not guaranteed in sandbox)
            const placeholderLogoUrl = "https://placehold.co/70x70/007bff/ffffff?text=LOGO"; // Example placeholder

            // Fetch logo as base64 if possible (more robust for general use, but might fail in sandbox)
            let logoBase64 = null;
            try {
                const response = await fetch('logo.png'); // Assuming logo.png is in the root
                if (response.ok) {
                    const blob = await response.blob();
                    logoBase64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.readAsDataURL(blob);
                    });
                } else {
                    console.warn('Failed to fetch logo.png, using placeholder.');
                    logoBase64 = placeholderLogoUrl;
                }
            } catch (e) {
                console.warn('Error fetching logo.png, using placeholder:', e);
                logoBase64 = placeholderLogoUrl;
            }

            if (logoBase64) {
                // Original logo dimensions: 1095 x 288 pixels
                // Aspect ratio: 1095 / 288 = 3.795
                const originalLogoWidth = 1095;
                const originalLogoHeight = 288;
                const targetLogoHeight = 15; // Keep height consistent with other elements
                const targetLogoWidth = (originalLogoWidth / originalLogoHeight) * targetLogoHeight;

                doc.addImage(logoBase64, 'PNG', logoX, logoY, targetLogoWidth, targetLogoHeight);
            }

            // Malla Title (Centered and larger)
            doc.setFontSize(18); // Increased font size for main title
            doc.setTextColor(accentColor);
            doc.text('Malla Curricular Química y Farmacia', pageWidth / 2, currentY + 10, { align: 'center' });

            // University Name (below title)
            doc.setFontSize(12);
            doc.setTextColor(textColor);
            doc.text('Universidad Adventista de Chile', pageWidth / 2, currentY + 16, { align: 'center' });

            // Credits and Theme/Date on the right
            doc.setFontSize(9);
            doc.setTextColor(textColor);
            doc.text(totalCreditsText, pageWidth - margin, currentY + 10, { align: 'right' });
            doc.text(`Tema: ${currentThemeDisplay}`, pageWidth - margin, currentY + 15, { align: 'right' });
            doc.text(`Fecha: ${currentDateTime}`, pageWidth - margin, currentY + 20, { align: 'right' });

            currentY += headerHeight + 5; // Move Y past the header

            // Group ramos by year and then by semester
            const yearsData = {};
            document.querySelectorAll('.year').forEach(yearElement => {
                const yearNum = yearElement.dataset.year;
                yearsData[yearNum] = {};
                yearElement.querySelectorAll('.semestre:not(.empty)').forEach(semesterElement => {
                    const semesterNum = semesterElement.dataset.sem;
                    yearsData[yearNum][semesterNum] = [];
                    semesterElement.querySelectorAll('.ramo').forEach(ramoElement => {
                        yearsData[yearNum][semesterNum].push({
                            code: ramoElement.dataset.code,
                            name: ramoElement.textContent.trim(),
                            area: ramoElement.dataset.area,
                            creditos: ramoElement.dataset.creditos,
                            approved: aprobados.has(ramoElement.dataset.code)
                        });
                    });
                });
            });

            const yearsPerRow = 3; // Number of years to display per row
            const yearHorizontalSpacing = 5; // Spacing between year blocks
            const availableWidth = pageWidth - (2 * margin);
            const yearBlockWidth = (availableWidth - (yearsPerRow - 1) * yearHorizontalSpacing) / yearsPerRow;
            const semesterColumnWidth = (yearBlockWidth - 5) / 2; // 5mm padding inside year block

            const ramoTextSize = 6; // Smaller font for ramos
            const ramoDotSize = 0.8; // Smaller dot size
            const ramoHeight = 7; // Height for each ramo block
            const ramoPadding = 1; // Padding around ramo text

            let currentYearIndex = 0;
            const sortedYears = Object.keys(yearsData).sort((a, b) => parseInt(a) - parseInt(b));

            for (const yearNum of sortedYears) {
                if (currentYearIndex % yearsPerRow === 0 && currentYearIndex !== 0) {
                    // Start a new row of years, check for new page
                    currentY += 10; // Vertical space between rows of years
                    if (currentY + 50 > pageHeight - margin) { // Estimate height for next year block
                        doc.addPage();
                        currentY = margin;
                    }
                }

                const yearBlockX = margin + (currentYearIndex % yearsPerRow) * (yearBlockWidth + yearHorizontalSpacing);
                let yearBlockY = currentY;
                let maxSemesterHeight = 0; // To align the bottom of year blocks

                // Draw year label
                doc.setFillColor(accent2Color);
                doc.rect(yearBlockX, yearBlockY, yearBlockWidth, 7, 'F'); // Year label background
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.text(`${yearNum}° AÑO`, yearBlockX + yearBlockWidth / 2, yearBlockY + 4, { align: 'center' });
                yearBlockY += 7; // Move past year label

                // Draw year block border (card color)
                doc.setDrawColor(cardColor);
                doc.setFillColor(cardColor);
                doc.rect(yearBlockX, yearBlockY, yearBlockWidth, 2, 'F'); // Small separator

                // Semesters for this year
                const semestersInYear = Object.keys(yearsData[yearNum]).sort((a,b) => parseInt(a) - parseInt(b));
                const semesterPairs = [];
                for(let i = 0; i < semestersInYear.length; i += 2) {
                    semesterPairs.push([semestersInYear[i], semestersInYear[i+1]]);
                }

                let currentSemesterY = yearBlockY + 2; // Start Y for semesters within the year block

                for (const pair of semesterPairs) {
                    let leftSemNum = pair[0];
                    let rightSemNum = pair[1];
                    let leftRamos = yearsData[yearNum][leftSemNum] || [];
                    let rightRamos = yearsData[yearNum][rightSemNum] || [];

                    let tempLeftY = currentSemesterY;
                    let tempRightY = currentSemesterY;

                    // Draw left semester
                    doc.setTextColor(accentColor);
                    doc.setFontSize(7);
                    doc.text(`${leftSemNum}° Semestre`, yearBlockX + 2, tempLeftY + 3);
                    tempLeftY += 5; // Space for semester title

                    doc.setDrawColor(textColor + '33'); // Lighter dashed border
                    doc.setFillColor(ramoBgColor);
                    
                    leftRamos.forEach(ramo => {
                        const ramoText = doc.splitTextToSize(ramo.name, semesterColumnWidth - (2 * ramoPadding) - 3); // 3 for dot width
                        const textHeight = ramoText.length * 2.5; // Estimate text height based on font size
                        const actualRamoHeight = Math.max(ramoHeight, textHeight + 2 * ramoPadding);

                        if (tempLeftY + actualRamoHeight > pageHeight - margin) {
                            // If ramo goes beyond page, add new page. This is complex for side-by-side.
                            // For simplicity, we'll just add a new page and continue, but this might break side-by-side layout.
                            // A more robust solution would require re-calculating the entire layout for new pages.
                            // For now, let's assume content fits or just overflows visually.
                        }

                        let ramoFillColor = ramoBgColor;
                        let ramoBorderColor = 'transparent';
                        if (ramo.approved) {
                            ramoFillColor = ramoAprobadoBgColor;
                            ramoBorderColor = greenColor;
                        }

                        doc.setFillColor(ramoFillColor);
                        doc.rect(yearBlockX + 2, tempLeftY, semesterColumnWidth, actualRamoHeight, 'F');
                        if (ramo.approved) {
                            doc.setDrawColor(ramoBorderColor);
                            doc.setLineWidth(0.5);
                            doc.line(yearBlockX + 2, tempLeftY, yearBlockX + 2, tempLeftY + actualRamoHeight); // Left border
                        }

                        doc.setTextColor(textColor);
                        doc.setFontSize(ramoTextSize);
                        doc.text(ramoText, yearBlockX + 2 + ramoPadding, tempLeftY + ramoPadding + (actualRamoHeight - textHeight) / 2);

                        // Draw dot to the right of the text
                        doc.setFillColor(createPdfDotColor(ramo.area, bodyStyle));
                        doc.circle(yearBlockX + 2 + semesterColumnWidth - ramoDotSize - ramoPadding, tempLeftY + actualRamoHeight / 2, ramoDotSize, 'F'); // Dot
                        
                        tempLeftY += actualRamoHeight + 1; // 1mm spacing between ramos
                    });

                    // Draw right semester (if it exists)
                    if (rightSemNum) {
                        doc.setTextColor(accentColor);
                        doc.setFontSize(7);
                        doc.text(`${rightSemNum}° Semestre`, yearBlockX + semesterColumnWidth + 3, tempRightY + 3);
                        tempRightY += 5; // Space for semester title

                        doc.setDrawColor(textColor + '33');
                        doc.setFillColor(ramoBgColor);

                        rightRamos.forEach(ramo => {
                            const ramoText = doc.splitTextToSize(ramo.name, semesterColumnWidth - (2 * ramoPadding) - 3);
                            const textHeight = ramoText.length * 2.5;
                            const actualRamoHeight = Math.max(ramoHeight, textHeight + 2 * ramoPadding);

                            let ramoFillColor = ramoBgColor;
                            let ramoBorderColor = 'transparent';
                            if (ramo.approved) {
                                ramoFillColor = ramoAprobadoBgColor;
                                ramoBorderColor = greenColor;
                            }

                            doc.setFillColor(ramoFillColor);
                            doc.rect(yearBlockX + semesterColumnWidth + 3, tempRightY, semesterColumnWidth, actualRamoHeight, 'F');
                            if (ramo.approved) {
                                doc.setDrawColor(ramoBorderColor);
                                doc.setLineWidth(0.5);
                                doc.line(yearBlockX + semesterColumnWidth + 3, tempRightY, yearBlockX + semesterColumnWidth + 3, tempRightY + actualRamoHeight);
                            }

                            doc.setTextColor(textColor);
                            doc.setFontSize(ramoTextSize);
                            doc.text(ramoText, yearBlockX + semesterColumnWidth + 3 + ramoPadding, tempRightY + ramoPadding + (actualRamoHeight - textHeight) / 2);

                            // Draw dot to the right of the text
                            doc.setFillColor(createPdfDotColor(ramo.area, bodyStyle));
                            doc.circle(yearBlockX + semesterColumnWidth + 3 + semesterColumnWidth - ramoDotSize - ramoPadding, tempRightY + actualRamoHeight / 2, ramoDotSize, 'F');
                            
                            tempRightY += actualRamoHeight + 1;
                        });
                    }
                    maxSemesterHeight = Math.max(maxSemesterHeight, tempLeftY, tempRightY);
                    currentSemesterY = maxSemesterHeight + 2; // Move Y for next pair of semesters
                }

                currentYearIndex++;
                if (currentYearIndex % yearsPerRow === 0) {
                    currentY = currentSemesterY + 10; // Reset Y for next row of years
                }
            }
            
            // Save the PDF
            doc.save(`malla_unach_qyf_progreso_${new Date().toISOString().slice(0,10)}.pdf`);
            showCustomAlert('Malla exportada exitosamente como PDF!');

        } catch (error) {
            console.error('Error al exportar la malla a PDF:', error);
            showCustomAlert('Hubo un error al exportar la malla a PDF. Inténtalo de nuevo.');
        } finally {
            // Restore button state
            exportImageBtn.textContent = originalButtonText;
            exportImageBtn.disabled = false;
        }
    });


    // Calendar logic
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const dayNames = ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"];

    function renderCalendar() {
        calendarGrid.innerHTML = ''; // Clear existing days
        currentMonthYear.textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;

        const firstDayOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
        const daysInMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0).getDate();
        const today = new Date();

        // Adjust first day to be Monday (0=Sunday, 1=Monday, ..., 6=Saturday)
        // If firstDayOfMonth.getDay() is 0 (Sunday), it should be 6 (last day of previous week)
        // Otherwise, it's day - 1
        let startDay = firstDayOfMonth.getDay();
        if (startDay === 0) startDay = 6; // Sunday becomes last day of week (index 6)
        else startDay = startDay - 1; // Monday=0, Tuesday=1, etc.

        // Fill leading empty days
        for (let i = 0; i < startDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.classList.add('calendar-day', 'empty');
            calendarGrid.appendChild(emptyDay);
        }

        // Fill days of the month
        for (let i = 1; i <= daysInMonth; i++) {
            const dayElement = document.createElement('div');
            dayElement.classList.add('calendar-day');
            dayElement.textContent = i;

            if (i === today.getDate() && currentCalendarDate.getMonth() === today.getMonth() && currentCalendarDate.getFullYear() === today.getFullYear()) {
                dayElement.classList.add('current-day');
            }
            calendarGrid.appendChild(dayElement);
        }
    }

    prevMonthBtn.addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        renderCalendar();
    });

    // Initial render of the calendar
    renderCalendar();

    // Inicialización de la UI al cargar la página
    updateUI();
  </script>
</body>
</html>
